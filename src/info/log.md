## 前言

本项目始于 2021 年夏，基于[星空列车与白的旅行](https://cusky.tk/webgal/hoshizora/)移植项目。

迄今为止，星夜已经经历了数次 UI 逻辑和核心逻辑的重构，由于工作量和时间的不平衡，此项目的目标或许在很长一段时间内都无法达到，在此，编写一个日志，记录这些时间以来对视觉小说引擎开发的经历和经验。

日志已经进行了一些重写和提炼，如果有疑问，可以尝试在文档的历史提交中查看旧日志。

## 这不是一个响应式网页！

对于视觉小说常见的 UI 布局而言，每一个按钮的大小、位置都是固定的，只需要根据屏幕大小保持比例，使用 scale 属性就能良好的实现这个效果。

不要使用`%` `em` `rem`的前端响应式方法构建界面，嵌套百分比会使得 CSS 难以阅读，浏览器字体不得小于 12px 的限制则最终使这个方法不能实现目的。

## 概念的基石：幕与命令

视觉小说的基本单元是幕，而操作的基本单元是命令，一幕包含若干条命令，在幕结束之后，需要等待用户点击进入下一幕，而在幕结束之前，用户点击则会立即结束本幕。

自动模式相当于在幕结束后代替用户进行点击操作，但是如果幕中的其他命令都已执行完毕，语音仍在播放，自动模式会等待语音播放完毕后进入下一幕，用户主动点击则会立即进入下一幕。

快进模式相当于在自动模式的基础上再代替用户点击一次，这样每一幕都会立即结束，呈现出来的就是每一幕的最终状态。

## 道路的分岔口：存档

存档是视觉小说系统的关键功能之一，要如何实现它呢？

或许可以想到快进和读档之间存在某种一致性，快进到存档位置相当于进行了读档，这种方式称为状态演算。

根据存档的字面含义，则可以想到存储当前的游戏状态，通过恢复它完成读档，这种方式称为状态存储。

状态演算从剧本第 0 幕开始，在读档过程中，舞台不应该呈现效果，状态演算需要通过技巧消除这些副作用。

外部输入，如用户选择的选项，不属于剧本的一部分，使用状态演算的方式也需要存储它们，并在读档过程中填入。

状态演算的缺点在于从第 0 幕开始计算状态，剧本越长读档速度就越慢，在千和万的数量级还可以接受，更长的剧本则需要通过拆分场景的方式解决。

状态存储需要维护一个状态表，这不能够通过简单的获取当前运行状态来实现。

在读档时需要从存档点所在幕的开头开始，所以需要某种方法获得幕开始和结束时的状态，根据状态表恢复状态也需要编写额外的代码。

状态存储的缺点在于状态表与实际舞台的运行时数据结构是分离的，每新增一个舞台元素，都需要对应的实现它在状态表中的存储和恢复操作。

## 从简单到复杂：组合

## 实现细节：幕与命令

## 实现细节：事件系统
