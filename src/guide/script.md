## 快速开始

下载[星夜引擎的发行版]()<br/><br/>
解压文件,打开引擎根目录下的`config.ini`,配置你的游戏信息<br/>
配置文件使用 ini 格式：等号两边不应有空格,`;`用于注释,在一行之内,`;`之后的内容会被忽略

```ini
; 你的游戏名称,会显示在浏览器的标签页上
name=咸鱼生活
; 你的游戏ID,根据此ID寻找游戏存档,修改ID会导致已保存的存档丢失
; 如果在同一域名下有多个游戏,需要配置此项,否则可以保持默认
key=be2c8cd9-3f9b
; 起始页的背景，文件放在image文件夹
TitleImg=Title2.png
; 起始页的背景音乐，文件放在audio文件夹
TitleBGM=夏影.mp3
```

复制以下内容到引擎根目录下的`scenario.txt`

```ts
----
@对话 名称:"咸鱼" 文本:"Hello World!"
@背景 文件:"saltlife.jpg"
@立绘 名称:"咸鱼" 文件:"saltfish/fish.jpg" x:640 y:640
----
```

运行`Start.exe`,会自动打开浏览器(如果没有请手动[打开](localhost:8888))<br/>
请注意,这时 Start.exe 应该保持运行并显示在你的任务栏,如果没有,请参考[常见问题](#Start.exe运行异常)<br/>
点击"开始游戏",显示如下:($一张图片,之后截)

## 需要了解的概念

#### 命令:

参考接下来的"命令"部分,操作某个元素(如音乐,图片等)的指令就称为命令

#### 幕:

玩家的一次点击会执行一幕,在一幕中可以有任意多个命令<br/>
如果第二次点击时有命令还未执行完毕,则会将命令快进至结束而不会进入下一幕

## 剧本基本格式

星夜引擎的剧本格式如下所示

```ts
----
@命令名称 命令参数:参数值 命令参数:参数值 //注释
----
@命令名称 命令参数:参数值 命令参数:参数值
----
```

`----`用于分割不同的幕<br/>
`//`用于注释,在一行之内,`//`之后的内容会被忽略<br/>

举个实际栗子

```ts
----
@背景 文件:"saltlife.jpg"
@立绘 名称:"咸鱼" 文件:"saltfish/fish.jpg" x:640 y:640
----
@对话 名称:"咸鱼" 文本:"啊这...\n摸了!" //完工,睡觉
----
```

命令参数的顺序是随意的,一行也可以有多条命令,所以下面这样写也是正确的<br/>
不过,推荐每行只写一条命令,并且使用一个固定的参数顺序

```ts
@背景 文件:"saltlife.jpg" @立绘 文件:"saltfish/fish.jpg" x:640 名称:"咸鱼" y:640
```

## 参数类型

星夜引擎的命令参数有三种类型,分别为`文本` `数字` `是否`<br/>

### 文本

一段文本,需要使用`""`包裹<br/>
也可以使用中文引号`“”`<br/>
在文本中可以使用`\n`来换行,也可以直接换行<br/>
如果想在`""`包裹的文本中使用`"`,则需要写成`\"`,`\`则写为`\\`<br/>
这在编程世界被称为**转义字符**,是一种常见的避免歧义的方式<br/>
在这里提到的转义字符应该能满足你的需要,可以阅读[转义字符](#转义字符)章节获取更多信息

### 数字

一个数字,如`50`、`1.2`

### 条件

`true`(是)或`false`(否)

## 常见参数

星夜引擎有一些常见的参数命名,以下说明它们代表的含义

### 名称

给当前命令操作的元素命名,如[放置立绘](#放置立绘)<br/>
也可能直接显示在游戏上,[显示对话](#显示对话)<br/>
这个参数是文本类型

### 目标

在一个命令为元素命名后,使用这个参数来明确"我要操作目标元素"<br/>
这个参数是文本类型

### 文件

告诉命令要使用哪个文件,或者,如果想更详细的区分文件类型,也可以使用`音频` `视频` `图片` 它们完全等价于 `文件`<br/>
可以使用`/`表达引擎目录下的子文件夹,比如`saltfish/fish.jpg`代表引擎目录下`saltfish`文件夹中的`fish.jpg`<br/>
这个参数是文本类型

### 空间

包含 `x`、`y`、`w`、`h`、`z`,在如[放置立绘](#放置立绘)等图像操作的命令中应用<br/>
`x`、`y`:相对于游戏画面左上角的坐标<br/>
`w`、`h`:图片的宽度和高度<br/>
`z`:图层的顺序,z 值大的图片会在 z 值小的图片前面显示<br/>
这个参数是数字类型

### 时间

持续时间,淡入时间,等待时间等等,都属于这个参数<br/>
目前,这个参数的单位是**毫秒**,1 秒等于 1000 毫秒<br/>
这个参数是数字类型

### 缓动

缓动函数是一种算法,可以实现淡入淡出等效果<br/>
本引擎使用`anime.js`实现缓动效果<br/>
可以参考[缓动函数速查表](https://www.xuanfengge.com/easeing/easeing/),填入链接展示的缓动函数之一,如`easeInSine`<br/>
或者,也可以查看[animejs 参考文档](https://animejs.com/documentation)中的`Easings`篇,了解本引擎支持的全部缓动种类<br/>
这个参数是文本类型

## 常用命令

### 对话和语音

#### 命令名称`@对话`

| 参数 |           功能           |
| ---- | :----------------------: |
| 文本 |   在对话框中展示的文本   |
| 名称 | 在对话框中展示的角色名称 |
| 文件 |     要播放的音频文件     |

其中`名称`、`文件`可选

如果省略了名称参数,它将继承前一幕的名称<br/>
如果想将对话框中的人物名称设置为空,则需要这样写: `名称:""`<br/>

#### 使用演示

```ts
@对话 文本:"咕咕咕"
```

```ts
@对话 名称:"鸽子" 文本:"咕咕咕" 文件:"咕.mp3"
```

### 设置背景

#### 命令名称`@背景`

| 参数 |                功能                |
| ---- | :--------------------------------: |
| 文件 |        要作为背景的图片文件        |
| 缓动 |      渐入效果要使用的缓动函数      |
| 时间 |         渐入效果的持续时间         |
| x    | 初始 x 坐标,默认值为 0(画面左上角) |
| y    | 初始 y 坐标,默认值为 0(画面左上角) |
| w    |   初始宽度,默认值为图片自身宽度    |
| h    |   初始高度,默认值为图片自身高度    |

其中`缓动`、`时间`、`x`、`y`、 `w`、`h`可选

#### 使用演示

```ts
@背景 文件:"咸鱼池塘.jpg" 缓动:"easeInQuad" 时间:500 x:-120
```

### 放置立绘

#### 命令名称`@背景`

| 参数 |                   功能                    |
| ---- | :---------------------------------------: |
| 名称 |                 角色名称                  |
| 文件 |             要使用的图片文件              |
| 缓动 |         渐入效果要使用的缓动函数          |
| 时间 |            渐入效果的持续时间             |
| x    |    初始 x 坐标,默认值为 0(画面左上角)     |
| y    |    初始 y 坐标,默认值为 0(画面左上角)     |
| z    | 初始 z 坐标,默认值为 1(背景的 z 坐标为 0) |
| w    |       初始宽度,默认值为图片自身宽度       |
| h    |       初始高度,默认值为图片自身高度       |

其中`缓动`、`时间`、`x`、`y`、`z`、`w`、`h`可选

如果已有相同名称的立绘存在,自动覆盖并继承空间参数("BG"被背景占用)

缓动和时间参数应当一起使用,如果省略它们,则不会使用渐入效果

#### 使用演示

```ts
@立绘 名称:"咸鱼" 文件:"saltfish/fish.jpg" x:640 y:640
```

### 关闭立绘

#### 命令名称`@关闭立绘`

| 参数 |          功能          |
| ---- | :--------------------: |
| 目标 | 要关闭的立绘的角色名称 |

其中`目标`可选

可以使用目标参数关闭某个特定的角色,或者省略它以关闭全部角色

#### 使用演示

```ts
@关闭立绘
```

```ts
@关闭立绘 目标:"咸鱼"
```

### 图像变换

#### 命令名称`@变换`

| 参数 |                      功能                      |
| ---- | :--------------------------------------------: |
| 目标 |             要操作的立绘的角色名称             |
| 缓动 | 变换效果要使用的缓动函数(默认值为 linear 线性) |
| 时间 |         变换效果的持续时间(默认值为 0)         |

变换效果可以使用空间参数,如果你了解 dom 和 css,它们所具有的数值属性应该都是可用的

你也可以查看[animejs 参考文档](https://animejs.com/documentation)中的`Properties`篇,了解变换效果可以使用的全部参数

以下列出一些可能比较常用的参数
| 参数 | 功能 |
| ---- | :--------------------------------------------: |
| x | x 坐标 |
| y | y 坐标 |
| z | z 坐标 |
| w | 宽度 |
| h | 高度 |
| opacity | 透明度 |
| rotate | 旋转 |
| scale | 缩放 |

变换效果使用相对坐标,比如,立绘本身具有 x:100,再使用变换命令设置 x:100,最后的结果则会是 x=200

#### 使用演示

```ts
@变换 目标:"咸鱼" 缓动:"cubic-bezier(0.55, 0.085, 0.68, 0.53)" 时间:1000 x:1280 rotate:180
```

### 摇晃效果

#### 命令名称`@摇晃`

| 参数 |          功能          |
| ---- | :--------------------: |
| 目标 | 要操作的立绘的角色名称 |
| 时间 |   摇晃效果的持续时间   |
| x    |   摇晃在横向上的幅度   |
| y    |   摇晃在竖向上的幅度   |

其中`x`、`y`可选

如果不使用`x`或`y`参数,则在该方向上不会应用摇晃效果

#### 使用演示

```ts
@摇晃 目标:"咸鱼" 时间:700 x:15
```

### 抖动效果

#### 命令名称`@抖动`

| 参数 |          功能          |
| ---- | :--------------------: |
| 目标 | 要操作的立绘的角色名称 |
| 时间 |   抖动效果的持续时间   |
| x    |   抖动在横向上的幅度   |
| y    |   抖动在竖向上的幅度   |

其中`x`、`y`可选

如果不使用`x`或`y`参数,则在该方向上不会应用抖动效果

抖动效果和摇晃效果的区别在于抖动效果的幅度随机,而摇晃效果的幅度固定

#### 使用演示

```ts
@抖动 目标:"咸鱼" 时间:700 x:15
```

### 播放音频

#### 命令名称`@音频`

| 参数 |                  功能                   |
| ---- | :-------------------------------------: |
| 类型 |           要操作的音轨的类型            |
| 文件 |            要使用的音频文件             |
| 名称 |           要操作的音轨的名称            |
| 循环 | 音频是否循环播放,默认值为 false(不循环) |
| 时间 |       音频缓入缓出效果的持续时间        |

其中`名称`、`循环`、`时间`可选

如果省略名称,则它的默认名称和类型相同

如果已有相同名称的音频存在,会覆盖原先的音频

设置时间参数会为新音频应用缓入效果,为旧音频应用缓出效果

类型可以是`BGM`(背景音乐) `SE`(音效) `Clip`(角色语音) `UISE`(按钮音效)

设置为某个类型的含义是将该音频轨道和对应类型的音量、中断等设置绑定

#### 使用演示

```ts
@音频 类型:"BGM" 文件:"bgm01.mp3" 循环:true 时间:1000
```

### 播放视频

#### 命令名称`@视频`

| 参数 |       功能       |
| ---- | :--------------: |
| 文件 | 要使用的视频文件 |

#### 使用演示

```ts
@视频 文件:"op.mp4"
```

### 跳转标志

#### 命令名称`@标志`

| 参数 |   功能   |
| ---- | :------: |
| 名称 | 标志名称 |

标志不产生任何实际效果,只用于跳转或选项命令跳转到对应的幕

无论此命令书写在幕的哪个位置,跳转过后都会从幕的开头开始执行

#### 使用演示

```ts
@标志 名称:"分支3"
```

### 跳转

#### 命令名称`@跳转`

| 参数 |      功能      |
| ---- | :------------: |
| 目标 | 标志名称或幕号 |

目标参数可以是一个标志或者一个幕号,幕号从零开始计数

#### 使用演示

```ts
@跳转 目标:"分支3"
```

### 选项

#### 命令名称`@选项`

| 参数 |        功能        |
| ---- | :----------------: |
| 名称 |   选项的描述文本   |
| 目标 |   标志名称或幕号   |
| 禁用 | 是否可以点击该选项 |

#### 使用演示

```ts
@选项 名称:"四处逛逛" 目标:"分支3" 禁用:true
```

#### 命令名称`@选择`

确保你想展示的所有选项命令都执行后,使用这个命令真正的把选项展示到屏幕上

这么做的目的是为了配合[变量](#变量)命令和[条件](#条件)控制,控制想要展示的选项

#### 使用演示

```ts
@选择
```

### 继续

#### 命令名称`@继续`

在本幕执行完毕之后,不需要用户点击就自动执行下一幕

#### 使用演示

```ts
@继续
```

### 变量

#### 命令名称`@变量`

| 参数 |        功能        |
| ---- | :----------------: |
| 名称 |      变量名称      |
| 类型 | 要操作的变量的类型 |
| 值   |  要设置给变量的值  |

类型可以是`temp`(临时变量) `local`(存档变量) `global`(全局变量)

临时变量在退出游戏后即失效,存档变量会随着存档恢复,全局变量由所有存档共享

值可以是引擎支持的文本,数字和条件类型的任意一种

#### 使用演示

```ts
@变量 名称:"周目" 类型:"global" 值:3
```

### 等待

#### 命令名称`@等待`

| 参数 |     功能     |
| ---- | :----------: |
| 时间 | 要等待的时间 |

在等待命令之后的命令会在指定的时间后执行

配合[流](#流)控制,可以更精细的设置命令的执行时机

#### 使用演示

```ts
@等待 时间:500
```

## 拆分剧本

可以在`scenario.txt`中标识剧本顺序,举例

```haskell
咕咕咕.txt => gugu.txt => 场景3.txt
=> 场景4.txt => 场景5.txt
```

可以在`=>`两端使用空格使格式更整齐,但这不是必须的<br/>
之后需要在对应文件中编写剧本,`scenario.txt`只用于标识剧本顺序

## 使用智能提示

只需要安装[VSCode](),并在 VSCode 中安装[插件](),即可使用提示功能<br/>
在剧本中输入@即可获得所有命令的提示,用 ↑↓ 键选择一个命令,按 Enter 键输入<br/>
这时光标会自动移动到第一个参数处并给出可能的提示,输入参数的值,按 Tab 键即可切换到下一个参数<br/>
如果你同时有其他代码编写需求,可以把剧本的格式从.txt 改为.ses,并在插件中设置"代码提示"<br/>
这个插件还提供一定的语法高亮和错误检查功能<br/><br/>
另外,VSCode 本身也支持一些方便的快捷键,具体可以查找[百度](https://www.baidu.com/s?wd=vscode%E5%B8%B8%E7%94%A8%E5%BF%AB%E6%8D%B7%E9%94%AE)<br/>
你或许会用到以下快捷键

```
向上/向下移动行 Alt+ ↑ / ↓
向上/向下复制行 Shift+Alt + ↓ / ↑
在文件内查找替换 Ctrl + F
```

## 别名(宏)

在引擎根目录下的`macro.txt`中配置宏<br/>
你应该会看到很多已经编写好的宏,新建一个空白行以编写你自己的宏<br/>
宏在剧本中有非常丰富的应用场景,以下是常用的对话命令的实际表示

```ts
@say text name file =>
@text text
@name name
@audio type:"Clip" file
@backlog text name file
----
@对话 名称 文本 文件 => @say text:{文本} name:{名称} file:{文件}
```

宏的展开顺序是从上到下,每个宏之间使用`----`分割<br/>
可以注意到,宏可以为命令参数设置默认值,为命令和参数设置别名,将多个命令合成为一个命令<br/>
另外,如果一个命令参数的类型为文本,那么可以用插值语法来简化文本中的重复部分<br/>

```ts
@音频 文件 => @音频 文件:"audio/{文件}"
```

## 基本命令

这是一些引擎的底层命令,在你需要用到它们之前,可以不必了解它们

### 设置名称

#### 命令名称`@名称`

| 参数 |           功能           |
| ---- | :----------------------: |
| 名称 | 在对话框中展示的角色名称 |

单独设置对话框中的角色名称

### 设置文本

#### 命令名称`@文本`

| 参数 |         功能         |
| ---- | :------------------: |
| 文本 | 在对话框中展示的文本 |

单独设置对话框中的文本

### 设置历史

#### 命令名称`@历史`

| 参数 |           功能           |
| ---- | :----------------------: |
| 文本 |   在对话框中展示的文本   |
| 名称 | 在对话框中展示的角色名称 |
| 文件 |     要播放的音频文件     |

手动向 Backlog 中添加一条记录

### 解锁 CG

#### 命令名称`@解锁CG`

| 参数 |          功能          |
| ---- | :--------------------: |
| 文件 | 要解锁的 CG 的文件路径 |

手动解锁一个 CG

## 命令流

### if
### async
### await
### par
### chain
### fork

## 转义字符

本引擎文本类型支持的全部转义字符如下所示

| 转义序列 |  描述  |
| -------- | :----: |
| \\'      |   '    |
| \\"      |   "    |
| \\\\     |   \\   |
| \b       | 退格符 |
| \f       | 换页符 |
| \n       | 换行符 |
| \r       | 回车符 |
| \t       | 制表符 |
