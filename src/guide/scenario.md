::: tip 注意
剧本是基于 JavaScript 的，但无需担心 —— 即使没有相关基础，只需花几分钟学习[基础语法](#javascript)即可轻松上手剧本编写。
:::

游戏的剧本应该放置于 `scenario` 文件夹中，游戏的资源应该放置于 `public/static` 文件夹中。

## 对话

对话是视觉小说中最高频的结构，所以拥有特殊简化的语法。

一条对话由三个部分组成，`角色名称` `:` `"对话文本"` `+` `"对话配音"`。

同一角色的多段对话可以省略角色名称，它将继承前一段对话的角色名称。

如果没有配音文件，也可以省略它。

```ts
'……我将踏上一段愉快的旅程。'
诺瓦: '……我将踏上一段愉快的旅程。' + '/AudioClip/noi0001.flac'
诺瓦: '……我将踏上一段愉快的旅程。'
'……我将踏上一段愉快的旅程。' + '/AudioClip/noi0001.flac'
```

简化形式对话的角色名称部分是由 JavaScript 的标签实现的，所以在遇到特殊字符，如中文问号时，可能需要使用[对话的命令形式](#对话-2)。

以数字开头或者空白的标签也是不合法的，为了使简化形式更加通用，角色名称开头的第一个 `$` 被视作空白，你可以使用 `$:` 切换到没有人物名称的旁白。

可以通过 [HTML](#html) 自定义文本样式，在简化形式对话中使用这项功能需要 `jsx` 或 `tsx` 格式的剧本。

```tsx
Message:<span style="color: red">
    这是一条<b>重要</b>的消息，需要你<i>特别</i>留意。
    下面的内容<u>请务必关注</u>，不要理会<s>已经废弃</s>的提示。
</span> + '0001.mp3'
```

## 幕

幕是剧情的基本单元，由若干条[命令](#命令)组成，幕中的命令执行完毕后，将等待用户点击进入下一幕。

编写对话将自动划分幕，也可以使用 `$action` 手动划分幕，在划分第 1 幕之前，称为第 0 幕，可以用于设置舞台的初始状态。

```ts
$执行.命令() // 第0幕
诺瓦: '……我将踏上一段愉快的旅程。' // 第1幕
$执行.命令() // 第1幕
'……与你一同的旅程。' // 第2幕
'无论何时……都与你一起……' // 第3幕
```

## 剧本

剧本文件的命名格式为 `*.scenario.(mjs|js|mts|ts|jsx|tsx)`，例如 `story.scenario.ts`。

`.scenario` 表示这是一个剧本文件，`.ts` 后缀表示所使用的 JavaScript 方言。

可以在剧本中使用完整的 JavaScript 语法，包括变量、条件和循环语句等，同时也可以使用对应方言的特性，比如 TypeScript 的类型标注。

剧情将从入口文件 `scenario/index.scenario.(mjs|js|mts|ts|jsx|tsx)` 开始。

### 拆分剧本

在剧本中使用 `$include` 将指定剧本的内容嵌入。

```ts
// scenario/index.scenario.tsx
诺瓦: '……我将踏上一段愉快的旅程。' // 第1幕
$include('./example.scenario.tsx') 
$执行.命令() // 第2幕
```

```ts
// scenario/example.scenario.tsx
$执行.命令() // 第1幕
'……与你一同的旅程。' // 第2幕
```

### 调试剧本

在剧本中使用 `$debugger` 让剧情从指定位置开始。

```ts
$执行.命令()
诺瓦: '……我将踏上一段愉快的旅程。'
$执行.命令()
'……与你一同的旅程。'
$debugger // 剧情将从这里开始
'无论何时……都与你一起……'
```

### 内置变量

在剧本中使用 `$store` 访问包括设置，存档在内的全部游戏数据。

```ts
system: `当前游戏名称为：${$store.system.name}`
```

在剧本中使用 `$context` 访问游戏实例当前的运行时数据。

```ts
system: `当前游戏状态为：${$context.state.now()}`
```

## 常见参数

本章节介绍一些常见的命令参数。

### 标识符

标识符，或者说 ID，用于后续操作时引用这个元素。

### 作用目标

操作元素的命令使用这个参数，填入目标的标识符。

### 持续时间

持续时间参数的单位为毫秒，具体所指参看命令说明。

### 资源路径

`public/static` 文件夹中的资源，填写时由 `/` 开头。

比如 `public/static/咕.mp3` ，填写为 `/咕.mp3` 。

## 命令

命令的基本格式是：`$模式.命令名称(命令参数)`

`模式` 表示命令的执行方式，分为以下两种：

-   `$执行` 表示执行本条命令并立即继续向下执行
-   `$等待` 表示等待本条命令完成后继续向下执行

不同命令支持的模式不同，有些可以选择两种模式之一，有些只能等待或不能等待。

本章节可按需查阅，编写剧本时可通过[智能提示](#智能提示)获得与本章节相同的命令介绍、参数说明等完整信息。

### 对话

显示对话内容，设置角色名称和播放配音。

**备注**

-   使用对话的命令形式不会自动划分幕。
-   与简化形式相同，名称参数开头的第一个`$`被视为空白。
-   通过传入 HTML 元素可以自定义文本样式。

#### 使用演示

```ts
$执行.对话({ 文本: "咕咕咕", 名称: "鸽子", 配音: "/咕.mp3" })
```

| 参数 | 功能                         |
| ---- | ---------------------------- |
| 文本 | 要显示的文本内容（必需）     |
| 名称 | 要显示的角色名称（可选）     |
| 配音 | 要播放的配音文件路径（可选） |

### 设置背景

设置背景图片，使用 GSAP 实现，支持位置、缩放、滤镜等属性。

**备注**

-   `持续时间` 仅控制背景图片的入场动画时长（淡入效果），其他属性（如位置、缩放、滤镜等）会立即应用。
-   参数值支持数值或字符串（如 "+=100"），`+=` 表示相对于当前值的增量，但并非所有参数支持此相对值语法。

#### 使用演示

```ts
$执行.设置背景({ 资源路径: "/咸鱼池塘.jpg", 持续时间: 500, X坐标: -120, 模糊: 5, 亮度: 1.2 })
```

| 参数         | 功能                                                        |
| ------------ | ----------------------------------------------------------- |
| 资源路径     | 背景图片的文件路径（必需）                                  |
| 持续时间     | 入场动画持续时间，单位毫秒（可选，默认 225）                |
| X 坐标       | 横坐标（可选，默认 0）                                      |
| Y 坐标       | 纵坐标（可选，默认 0）                                      |
| 宽度         | 图片宽度（可选，默认图片自身宽度）                          |
| 高度         | 图片高度（可选，默认图片自身高度）                          |
| X 轴缩放     | 横轴缩放比例（可选，默认 1）                                |
| Y 轴缩放     | 纵轴缩放比例（可选，默认 1）                                |
| 旋转角度     | 图片旋转角度，单位为度（可选）                              |
| 斜切         | 整体斜切变换（可选）                                        |
| X 轴斜切     | 横轴斜切变换（可选）                                        |
| Y 轴斜切     | 纵轴斜切变换（可选）                                        |
| 中心点       | 图片整体变换的基准点（可选）                                |
| X 轴中心点   | 横轴变换的基准点（可选）                                    |
| Y 轴中心点   | 纵轴变换的基准点（可选）                                    |
| 锚点         | 图片整体纹理的锚点，范围 0 到 1（可选）                     |
| X 轴锚点     | 横轴纹理的锚点（可选）                                      |
| Y 轴锚点     | 纵轴纹理的锚点（可选）                                      |
| 模糊         | 整体模糊效果强度（可选）                                    |
| 横向模糊     | 横向模糊效果强度（可选）                                    |
| 纵向模糊     | 纵向模糊效果强度（可选）                                    |
| 模糊边距     | 模糊效果的边距（可选）                                      |
| 亮度         | 亮度调整，范围 0 到无穷大（可选，1 为无调整）               |
| 对比度       | 对比度调整，范围 0 到无穷大（可选，1 为无调整）             |
| 色相         | 色相调整，单位为度（可选，0 为无调整）                      |
| 饱和度       | 饱和度调整，范围 0 到无穷大（可选，1 为无调整）             |
| 着色         | 着色效果，接受颜色值（如 "#ff0000" 或 0xff0000）（可选）    |
| 着色强度     | 着色效果强度，范围 0 到 1（可选，0 为无着色，1 为完全着色） |
| 颜色矩阵滤镜 | 自定义颜色矩阵滤镜对象（可选）                              |
| 合并颜色矩阵 | 是否合并颜色矩阵滤镜（可选，默认 false）                    |
| 变换矩阵     | 自定义变换矩阵，类型为 PixiPlugin.PixiMatrix（可选）        |

### 设置立绘

设置角色立绘图片，使用 GSAP 实现，支持位置、缩放、滤镜等属性。

**备注**

-   多次为同一标识符设置新立绘时，应确保之前的入场动画已完成，以避免亮度异常的错误。
-   `持续时间` 仅控制立绘图片的入场动画时长（淡入效果），其他属性（如位置、缩放、滤镜等）会立即应用。
-   参数值支持数值或字符串（如 "+=100"），`+=` 表示相对于当前值的增量，但并非所有参数支持此相对值语法。

#### 使用演示

```ts
$执行.设置立绘({ 标识符: "咸鱼", 资源路径: "/saltfish/fish.jpg", 持续时间: 500, X坐标: 640, Y坐标: 640, 模糊: 5 })
```

| 参数         | 功能                                                           |
| ------------ | -------------------------------------------------------------- |
| 标识符       | 立绘的标识符，用于后续操作（必需）                             |
| 资源路径     | 立绘图片的文件路径（必需）                                     |
| 持续时间     | 入场动画持续时间，单位毫秒（可选，默认 225）                   |
| 图层高度     | 立绘的图层高度，控制遮挡关系，值越大越靠前显示（可选，默认 1） |
| X 坐标       | 横坐标（可选，默认 0）                                         |
| Y 坐标       | 纵坐标（可选，默认 0）                                         |
| 宽度         | 图片宽度（可选，默认图片自身宽度）                             |
| 高度         | 图片高度（可选，默认图片自身高度）                             |
| X 轴缩放     | 横轴缩放比例（可选，默认 1）                                   |
| Y 轴缩放     | 纵轴缩放比例（可选，默认 1）                                   |
| 旋转角度     | 图片旋转角度，单位为度（可选）                                 |
| 斜切         | 整体斜切变换（可选）                                           |
| X 轴斜切     | 横轴斜切变换（可选）                                           |
| Y 轴斜切     | 纵轴斜切变换（可选）                                           |
| 中心点       | 图片整体变换的基准点（可选）                                   |
| X 轴中心点   | 横轴变换的基准点（可选）                                       |
| Y 轴中心点   | 纵轴变换的基准点（可选）                                       |
| 锚点         | 图片整体纹理的锚点，范围 0 到 1（可选）                        |
| X 轴锚点     | 横轴纹理的锚点（可选）                                         |
| Y 轴锚点     | 纵轴纹理的锚点（可选）                                         |
| 模糊         | 整体模糊效果强度（可选）                                       |
| 横向模糊     | 横向模糊效果强度（可选）                                       |
| 纵向模糊     | 纵向模糊效果强度（可选）                                       |
| 模糊边距     | 模糊效果的边距（可选）                                         |
| 亮度         | 亮度调整，范围 0 到无穷大（可选，1 为无调整）                  |
| 对比度       | 对比度调整，范围 0 到无穷大（可选，1 为无调整）                |
| 色相         | 色相调整，单位为度（可选，0 为无调整）                         |
| 饱和度       | 饱和度调整，范围 0 到无穷大（可选，1 为无调整）                |
| 着色         | 着色效果，接受颜色值（如 "#ff0000" 或 0xff0000）（可选）       |
| 着色强度     | 着色效果强度，范围 0 到 1（可选，0 为无着色，1 为完全着色）    |
| 颜色矩阵滤镜 | 自定义颜色矩阵滤镜对象（可选）                                 |
| 合并颜色矩阵 | 是否合并颜色矩阵滤镜（可选，默认 false）                       |
| 变换矩阵     | 自定义变换矩阵，类型为 PixiPlugin.PixiMatrix（可选）           |

### 添加动画

为指定目标添加动画效果，使用 GSAP 实现，支持位置、缩放、滤镜等属性。

**备注**

-   针对同一目标的多个动画将按顺序执行，前一个动画完成后触发后一个动画。
-   可访问 [GSAP 文档](https://gsap.com/docs/v3/Eases/CustomEase) 查看 GSAP 缓动预设或创建自定义缓动曲线。
-   参数值支持数值或字符串（如 "+=100"），`+=` 表示相对于当前值的增量，但并非所有参数支持此相对值语法。

#### 使用演示

```ts
$执行.添加动画({ 作用目标: "咸鱼", 持续时间: 1000, X坐标: "+=100", Y坐标: 720, 缓动函数: "M0,0,C0,0,1,1,1,1" })
```

| 参数         | 功能                                                                  |
| ------------ | --------------------------------------------------------------------- |
| 作用目标     | 动画应用的目标标识符，舞台的标识符为 0，背景的标识符为 1（必需）      |
| 持续时间     | 动画持续时间，单位毫秒（可选，默认 0，无动画）                        |
| 缓动函数     | 动画缓动函数，支持 GSAP 缓动预设、缓动曲线或函数（可选，默认 "none"） |
| 继承         | 是否在切换图像后继承当前动画属性（可选，默认 true）                   |
| X 坐标       | 横坐标（可选，默认 0）                                                |
| Y 坐标       | 纵坐标（可选，默认 0）                                                |
| 宽度         | 图片宽度（可选，默认图片自身宽度）                                    |
| 高度         | 图片高度（可选，默认图片自身高度）                                    |
| X 轴缩放     | 横轴缩放比例（可选，默认 1）                                          |
| Y 轴缩放     | 纵轴缩放比例（可选，默认 1）                                          |
| 旋转角度     | 图片旋转角度，单位为度（可选）                                        |
| 斜切         | 整体斜切变换（可选）                                                  |
| X 轴斜切     | 横轴斜切变换（可选）                                                  |
| Y 轴斜切     | 纵轴斜切变换（可选）                                                  |
| 中心点       | 图片整体变换的基准点（可选）                                          |
| X 轴中心点   | 横轴变换的基准点（可选）                                              |
| Y 轴中心点   | 纵轴变换的基准点（可选）                                              |
| 锚点         | 图片整体纹理的锚点，范围 0 到 1（可选）                               |
| X 轴锚点     | 横轴纹理的锚点（可选）                                                |
| Y 轴锚点     | 纵轴纹理的锚点（可选）                                                |
| 模糊         | 整体模糊效果强度（可选）                                              |
| 横向模糊     | 横向模糊效果强度（可选）                                              |
| 纵向模糊     | 纵向模糊效果强度（可选）                                              |
| 模糊边距     | 模糊效果的边距（可选）                                                |
| 亮度         | 亮度调整，范围 0 到无穷大（可选，1 为无调整）                         |
| 对比度       | 对比度调整，范围 0 到无穷大（可选，1 为无调整）                       |
| 色相         | 色相调整，单位为度（可选，0 为无调整）                                |
| 饱和度       | 饱和度调整，范围 0 到无穷大（可选，1 为无调整）                       |
| 着色         | 着色效果，接受颜色值（如 "#ff0000" 或 0xff0000）（可选）              |
| 着色强度     | 着色效果强度，范围 0 到 1（可选，0 为无着色，1 为完全着色）           |
| 颜色矩阵滤镜 | 自定义颜色矩阵滤镜对象（可选）                                        |
| 合并颜色矩阵 | 是否合并颜色矩阵滤镜（可选，默认 false）                              |
| 变换矩阵     | 自定义变换矩阵，类型为 PixiPlugin.PixiMatrix（可选）                  |

### 添加滤镜

为指定目标添加滤镜，使用 PixiJS 滤镜实现。

**备注**

-   滤镜动画可通过 `基本动画` 命令实现。

*   可访问 [PixiJS 滤镜示例](https://pixijs.io/filters/examples/) 查看 Pixi 滤镜预设的画面表现。

#### 使用演示

```ts
$执行.添加滤镜({ 作用目标: "咸鱼", 滤镜实例: new BlurFilter(5) })
```

| 参数     | 功能                                                             |
| -------- | ---------------------------------------------------------------- |
| 作用目标 | 滤镜应用的目标标识符，舞台的标识符为 0，背景的标识符为 1（必需） |
| 滤镜实例 | PixiJS 滤镜实例，需 economia 有效的 Filter 对象（必需）          |

### 动效动画

为指定目标应用一段动效动画。

**备注**

-   动效动画会独立于主动画序列同时运行，但同一时间只应运行一个动效动画。

#### 使用演示

```ts
$执行.动效动画({ 作用目标: "咸鱼", 预设名称: "摇晃", Y轴幅度: 15, 持续时间: 1000 })
```

| 参数     | 功能                                                             |
| -------- | ---------------------------------------------------------------- |
| 作用目标 | 动画应用的目标标识符，舞台的标识符为 0，背景的标识符为 1（必需） |
| 预设名称 | 动画名称，如 "震动" 或 "摇晃"（必需）                            |
| 持续时间 | 动画持续时间，单位毫秒（必需）                                   |
| X 轴幅度 | 横向动画幅度（可选，需至少提供 X 轴幅度 或 Y 轴幅度 之一）       |
| Y 轴幅度 | 纵向动画幅度（可选，需至少提供 X 轴幅度 或 Y 轴幅度 之一）       |

### 关闭图像

关闭指定的立绘或背景，支持淡出动画。

**备注**

-   `持续时间` 控制图像消失时的淡出动画时长。
-   `作用目标` 可以是一个或多个标识符组成的数组，用于同时关闭多个图像。

#### 使用演示

```ts
// 关闭单个立绘
$执行.关闭图像({ 作用目标: "咸鱼" })
// 同时关闭多个立绘
$执行.关闭图像({ 作用目标: ["咸鱼", "鸽子"] })
```

| 参数     | 功能                                                       |
| -------- | ---------------------------------------------------------- |
| 作用目标 | 关闭图像的目标标识符或标识符数组，背景的标识符为 1（必需） |
| 持续时间 | 淡出动画的持续时间，单位毫秒（可选，默认 225）             |

### 清空立绘

立即移除所有立绘，无淡出动画。

#### 使用演示

```ts
$执行.清空立绘()
```

### 设置配乐

设置背景音乐（BGM），使用 Howler 实现，支持音量、循环播放等属性。

**备注**

-   `持续时间` 控制音量缓入缓出的持续时间。
-   如果提供 `音量` 参数，音频将通过 `持续时间` 渐入到指定音量。
-   `音量`、`播放速度` 等参数不会在同一音轨上继承，需重新设置。

#### 使用演示

```ts
$执行.设置配乐({ 资源路径: "/bgm01.mp3", 持续时间: 1000, 音量: 0.5 })
```

| 参数       | 功能                                                                    |
| ---------- | ----------------------------------------------------------------------- |
| 资源路径   | 音频的文件路径（必需）                                                  |
| 标识符     | 音轨的标识符（可选，默认 "bgm"）                                        |
| 持续时间   | 音量缓入缓出时间，单位毫秒（可选，默认 0）                              |
| 音量       | 音频的音量，范围 0 到 1（可选，默认 1）                                 |
| 循环播放   | 是否循环播放（可选，默认 true）                                         |
| 播放速度   | 音频播放速度，范围 0.5 到 4（可选，1 为无调整）                         |
| 使用 HTML5 | 是否使用 HTML5 音频播放，适合大文件以减少加载时间（可选，默认自动选择） |

### 设置音效

设置音效（SE），使用 Howler 实现，支持音量、循环播放等属性。

**备注**

-   `持续时间` 控制音量缓入缓出的持续时间。
-   如果提供 `音量` 参数，音频将通过 `持续时间` 渐入到指定音量。
-   `音量`、`播放速度` 等参数不会在同一音轨上继承，需重新设置。

#### 使用演示

```ts
$执行.设置音效({ 资源路径: "/se01.mp3", 循环播放: true, 持续时间: 500, 音量: 0.7 })
```

| 参数       | 功能                                                                    |
| ---------- | ----------------------------------------------------------------------- |
| 资源路径   | 音频的文件路径（必需）                                                  |
| 标识符     | 音轨的标识符（可选，默认 "se"）                                         |
| 持续时间   | 音量缓入缓出时间，单位毫秒（可选，默认 0）                              |
| 音量       | 音频的音量，范围 0 到 1（可选，默认 1）                                 |
| 循环播放   | 是否循环播放（可选，默认 false）                                        |
| 播放速度   | 音频播放速度，范围 0.5 到 4（可选，1 为无调整）                         |
| 使用 HTML5 | 是否使用 HTML5 音频播放，适合大文件以减少加载时间（可选，默认自动选择） |

### 设置配音

设置角色配音（Clip），使用 Howler 实现，支持音量、播放速度等属性。

**备注**

-   配音的音轨标识符固定为 "clip"。
-   通常应使用 `对话` 命令设置配音，单独使用 `设置配音` 将不会记录到 Backlog。
-   `音量`、`播放速度` 等参数不会在同一音轨上继承，需重新设置。

#### 使用演示

```ts
$执行.设置配音({ 资源路径: "/noi01.mp3", 音量: 0.8, 播放速度: 1.2 })
```

| 参数       | 功能                                                                    |
| ---------- | ----------------------------------------------------------------------- |
| 资源路径   | 音频的文件路径（必需）                                                  |
| 音量       | 音频的音量，范围 0 到 1（可选，默认 1）                                 |
| 播放速度   | 音频播放速度，范围 0.5 到 4（可选，1 为无调整）                         |
| 使用 HTML5 | 是否使用 HTML5 音频播放，适合大文件以减少加载时间（可选，默认自动选择） |

### 设置音量

设置指定音轨的音量，使用 Howler 实现，支持渐变过渡。

**备注**

-   `持续时间` 控制音量渐变的过渡时间，未设置时音量立即应用。

#### 使用演示

```ts
$执行.设置音量({ 作用目标: "bgm", 音量: 0.5, 持续时间: 1000 })
```

| 参数     | 功能                               |
| -------- | ---------------------------------- |
| 作用目标 | 音轨的标识符（必需）               |
| 音量     | 目标音量，范围 0 到 1（必需）      |
| 持续时间 | 音量渐变过渡时间，单位毫秒（可选） |

### 关闭音频

关闭指定音轨的音频，使用 Howler 实现，支持渐变淡出。

**备注**

-   `持续时间` 控制音量渐出的过渡时间，未设置时立即关闭。

#### 使用演示

```ts
$执行.关闭音频({ 作用目标: "bgm", 持续时间: 1000 })
```

| 参数     | 功能                               |
| -------- | ---------------------------------- |
| 作用目标 | 要关闭的音轨标识符（必需）         |
| 持续时间 | 音量渐出过渡时间，单位毫秒（可选） |

### 转场动画

播放一段转场动画。

**备注**

-   转场动画用于场景切换，但不会自动处理背景或立绘的转场。

#### 使用演示

```ts
$执行.转场动画("BlindH8")
```

| 参数     | 功能                         |
| -------- | ---------------------------- |
| 预设名称 | 转场动画名称（如 "BlindH8"） |

### 播放视频

播放视频。

#### 使用演示

```ts
$等待.播放视频({ 资源路径: "/OP.mp4", 允许跳过: false })
```

| 参数     | 功能                                    |
| -------- | --------------------------------------- |
| 资源路径 | 视频的文件路径（必需）                  |
| 允许跳过 | 是否允许用户跳过视频（可选，默认 true） |

### 用户输入

显示输入框并获取用户输入的文本。

**返回值**

-   用户输入的文本

#### 使用演示

```ts
const res = $等待.用户输入({ 描述文本: "请输入你的名字" })
```

| 参数     | 功能                         |
| -------- | ---------------------------- |
| 描述文本 | 输入框显示的提示文本（可选） |

### 用户选择

显示选项列表并获取用户所选项的标识符。

**返回值**

-   用户所选项的标识符

#### 使用演示

```ts
const label = $等待.用户选择([
  { 标识符: "*そのまま渡す", 描述文本: "直接给她" },
  { 标识符: "*振ってから渡す", 描述文本: "晃晃再给她" },
])
```

| 参数     | 功能                               |
| -------- | ---------------------------------- |
| 标识符   | 选项的标识符（必需）               |
| 描述文本 | 选项显示的文本（必需）             |
| 禁用     | 是否禁用该选项（可选，默认 false） |

### 用户点击

等待用户点击。

#### 使用演示

```ts
$等待.用户点击()
```

### 显示界面

显示或隐藏游戏的 UI 界面（如文本框、选项栏等）。

**备注**

-   设置 `false` N 次，需相应设置 `true` N 次以复位。

#### 使用演示

```ts
$执行.显示界面(true)
```

| 参数 | 功能                             |
| ---- | -------------------------------- |
| 状态 | `true` 为显示，`false` 为隐藏 ！ |

### 允许点击

允许或禁止用户点击以继续剧情。

**备注**

-   设置 `false` N 次，需相应设置 `true` N 次以复位。

#### 使用演示

```ts
$执行.允许点击(true)
```

| 参数 | 功能                              |
| ---- | --------------------------------- |
| 状态 | `true` 为允许，`false` 为禁止点击 |

### 解锁鉴赏

解锁 CG 或其他鉴赏内容。

**备注**

-   在默认情况下，设置背景、立绘、音频等时，将自动解锁相关鉴赏内容。

#### 使用演示

```ts
$执行.解锁鉴赏("cg01.jpg")
```

| 参数     | 功能                       |
| -------- | -------------------------- |
| 资源路径 | 要解锁的 CG 或内容文件路径 |

### 解锁成就

解锁指定成就。

#### 使用演示

```ts
$执行.解锁成就(1)
```

| 参数    | 功能       |
| ------- | ---------- |
| 成就 ID | 成就的编号 |

### 自动继续

自动进入下一幕，无需用户点击。

#### 使用演示

```ts
$执行.自动继续()
```

### 系统计时

等待指定时间。

#### 使用演示

```ts
$等待.系统计时(500)
```

| 参数 | 功能               |
| ---- | ------------------ |
| 时间 | 等待时间，单位毫秒 |

### 结束剧情

结束剧情，停止后续执行。

**备注**

-   在默认情况下，命令执行后将返回标题页。

#### 使用演示

```ts
$执行.结束剧情()
```

### 嵌入页面

嵌入 iframe 页面，显示外部内容。

**备注**

-   嵌入的页面需通过 `window.parent.postMessage` 发送结果，发送的数据将作为命令返回值。

**返回值**

-   页面发送的结果数据

#### 使用演示

```ts
$等待.嵌入页面({ 资源路径: "example.com" })
```

| 参数     | 功能                  |
| -------- | --------------------- |
| 资源路径 | iframe 的 URL（必需） |

### 基本输入

执行自定义输入并返回结果。

**备注**

-   如果程序的结果不是确定的，如获取日期、随机数或外部输入，可以使用此命令。

**返回值**

-   回调函数的结果

#### 使用演示

```ts
$等待.基本输入(async () => new Date().toISOString())
```

| 参数     | 功能                        |
| -------- | --------------------------- |
| 回调函数 | 返回 Promise 的函数（必需） |

### 基本动画

为任意对象添加动画效果，使用 GSAP 实现。

**备注**

-   可访问 [GSAP 文档](https://gsap.com/resources/position-parameter) 查看 GSAP 位置参数用法。
-   可访问 [GSAP 文档](https://gsap.com/docs/v3/Eases/CustomEase) 查看 GSAP 缓动预设或创建自定义缓动曲线。
-   参数值支持数值或字符串（如 "+=100"），`+=` 表示相对于当前值的增量，但并非所有参数支持此相对值语法。

#### 使用演示

```ts
$执行.基本动画({ 目标: document.querySelector(".box"), 持续时间: 1000, x: "+=100", opacity: 0.5 })
```

| 参数     | 功能                                                                                 |
| -------- | ------------------------------------------------------------------------------------ |
| 目标     | 动画应用的目标对象，接受 GSAP 支持的 TweenTarget（必需）                             |
| 模式     | 动画模式，"from" 表示从指定值开始，"to" 表示到指定值结束（可选，默认 "to"）          |
| 持续时间 | 动画持续时间，单位毫秒（可选，默认 0）                                               |
| 缓动函数 | 动画缓动函数，支持 GSAP 缓动预设、缓动曲线或函数（可选，默认 "none"）                |
| 标识符   | 动画序列的标识符，针对同一标识符的多个动画将按顺序执行（可选，默认与目标参数值相同） |
| 位置     | 动画在 GSAP 动画序列中的位置，可传入符合 GSAP 位置参数要求的值（可选）               |
| 动画属性 | 目标对象的任意属性，如 scale、opacity 等                                             |

## 实用技巧

### 智能提示

通过使用 [Visual Studio Code](https://code.visualstudio.com/) 编辑器来获得智能提示。

编写命令时：

-   输入 `$` 开始，然后选择一个前缀：`$` -> `$执行`
-   输入 `.` 查看该前缀下的可用命令：`$执行.` -> `$执行.命令`
-   如果命令参数是一个字典，输入 `'` 查看可填写的参数：`$执行.命令({ '' })` -> `$执行.命令({ '命令参数' })`
-   输入`/`可以获得资源目录下可用资源的提示：`$执行.命令({ '资源路径': '/' })` -> `$执行.命令({ '资源路径': '/图片.png' })`

获取提示后，用 `↑↓` 键选择，按 `Enter` 键确认输入。

将光标悬停于命令名称上就能看见命令的详细介绍。

---

### 快捷键

| 操作                | 快捷键                |
| ------------------- | --------------------- |
| 向上/向下移动当前行 | `Alt + ↑ / ↓`         |
| 向上/向下复制当前行 | `Shift + Alt + ↑ / ↓` |
| 在文件中查找替换    | `Ctrl + F`            |

## 参考示例

以下为`星空列车与白的旅行`的剧情片段

```ts
$执行.设置背景({ 资源路径: '/ImageAsset/bg_black.webp', X坐标: 0, Y坐标: 0 })
诺瓦: '……我将踏上一段愉快的旅程。' + '/AudioClip/noi0001.flac'
$执行.设置背景({ 资源路径: '/ImageAsset/bg_white.webp', 缩放: 2, 持续时间: 1000 })
'……与你一同的旅程。' + '/AudioClip/noi0002.flac'
'无论何时……都与你一起……' + '/AudioClip/noi0003.flac'
$执行.设置背景({ 资源路径: '/ImageAsset/bg000d.webp', 缩放: 1.021, 持续时间: 1000 })
$: ' ——哐当哐当。'
$执行.设置背景({ 资源路径: '/ImageAsset/bg040c.webp', 缩放: 1.021, 持续时间: 1000 })
$执行.设置音效({ 资源路径: '/AudioClip/se004.flac', 循环播放: true })
晓: '……'
$执行.设置背景({ 资源路径: '/ImageAsset/evcg01a.webp', 持续时间: 500.0 })
$: ' 清风吹拂。\n 与其说是风在吹。'
' 不如说我正以子弹般的速度在清风里穿梭。'
$执行.设置背景({ 资源路径: '/ImageAsset/evcg01b.webp', 持续时间: 500.0 })
$执行.设置配乐({ 资源路径: '/AudioClip/bgm03.flac', 持续时间: 0 })
' 深夜火车之旅。'
' 旅行着实令人享受。'
' 在旅途中总有意想不到的事物在前方等候。'
$执行.设置背景({ 资源路径: '/ImageAsset/evcg01a.webp', 持续时间: 1000 })
$action
$执行.关闭音频({ 作用目标: 'se', 持续时间: 0 })
$执行.关闭图像({ 作用目标: 1, 持续时间: 200 })
$执行.设置背景({ 资源路径: '/ImageAsset/bg040c.webp', 缩放: 1.021, 持续时间: 1000 })
$执行.显示界面(false)
$等待.系统计时(500.0)
$执行.显示界面(true)
$执行.对话({ 名称: '黑猫', 文本: '喵。', 语音: '/AudioClip/kur0001.flac' })
$执行.动效动画({ 作用目标: 0, 预设名称: '摇晃', X轴幅度: 15, 持续时间: 1000 })
晓: '嗯……哎呀。'
'来这里。'
$执行.设置背景({ 资源路径: '/ImageAsset/bg_black.webp', 缩放: 2, 持续时间: 500.0 })
黑猫: '呼哧。' + '/AudioClip/kur0002.flac'
$执行.设置背景({
    资源路径: '/ImageAsset/large_evcg01c.webp',
    X坐标: -840.0,
    Y坐标: -610.0,
    持续时间: 500.0
})
$执行.动效动画({ 作用目标: 0, 预设名称: '摇晃', Y轴幅度: 15, 持续时间: 2000 })
$: ' 这位旅伴自然而然地跳上了我的大腿。'
' 沉甸甸又暖洋洋的。'
晓: '你总是这么神出鬼没的。'
黑猫: '咪。' + '/AudioClip/kur0003.flac'
晓: '……'
$执行.设置背景({ 资源路径: '/ImageAsset/evcg01c2.webp', 持续时间: 500.0 })
$: ' 我再次望向窗外。\n 它金色的眼瞳也随我的视线转向外边。'
$action
$执行.关闭图像({ 作用目标: 1, 持续时间: 200 })
$执行.设置背景({ 资源路径: '/ImageAsset/bg000d.webp', 缩放: 1.021, 持续时间: 3000 })
$执行.显示界面(false)
$等待.系统计时(1000)
$执行.显示界面(true)
$执行.对话({ 文本: ' 美丽的星空在我眼前展开。' })
' 璀璨夺目，犹如熠熠生辉的宝石箱。'
' 这就是此行最大的收获了吧。'
' 大概，那是我上小学的时候。'
' 不知道是校长还是班主任，又或是一个遗忘在脑海的人。\n 总之曾有人对我说过这样一句话。'
$执行.设置背景({ 资源路径: '/ImageAsset/bg_black.webp', 缩放: 2, 持续时间: 500.0 })
' “这个世界就是个巨大的宝石箱。”'
' 璀璨夺目，犹如熠熠生辉的宝石箱。'
$执行.设置背景({ 资源路径: '/ImageAsset/bg000d.webp', 缩放: 1.021, 持续时间: 1000 })
' 如今长大成人了的我才意识到。'
' 这句话精确地形容了这个世界，\n 等我有了后代，应该也会把这句话教给他吧。\n 我也想如此对他这么说。用来准确形容这个世界。'
$执行.设置背景({ 资源路径: '/ImageAsset/bg_black.webp', 缩放: 2, 持续时间: 1000 })
' 可讽刺的是，这熠熠生辉的宝石箱究竟蕴含着怎样的“意义”。'
' 我已然了如指掌。'
$action
$执行.关闭音频({ 作用目标: 'bgm', 持续时间: 2000 })
$执行.设置背景({ 资源路径: '/ImageAsset/bg000a.webp', 缩放: 1.021, 持续时间: 3000 })
$执行.显示界面(false)
$等待.系统计时(500.0)
$执行.显示界面(true)
$执行.对话({ 文本: ' 旅行前一天——。' })
' ・・・・・'
$执行.设置音效({ 资源路径: '/AudioClip/se014.flac', 循环播放: true })
晓: '……好热。'
$: ' 骄阳似火。'
' 与其说耀眼，不如说是刺眼的阳光。\n 毫不留情地照射在我身上。'
' 这个成语正适合形容现在的气温。'
' 铄石流金。'
' 真是恰到好处。'
' 在烈日的暴晒下，我甚至感觉脑浆都要沸腾了。'
' 我住在岩手县的乡下。\n 这里离东北部的山区很近。'
$执行.设置配乐({ 资源路径: '/AudioClip/bgm02.flac', 持续时间: 0 })
$执行.设置背景({ 资源路径: '/ImageAsset/bg020a.webp', 缩放: 1.021, 持续时间: 500.0 })
' 冬季里常常白雪皑皑。\n 属于日本少见的寒冷地带。'
' 然而现在却热得反常。'
' 不禁让人愈发担心起气候变暖的问题。'
晓: '……'
$执行.设置背景({ 资源路径: '/ImageAsset/bg_black.webp', 缩放: 2, 持续时间: 500.0 })
$执行.动效动画({ 作用目标: 0, 预设名称: '摇晃', X轴幅度: 30, 持续时间: 2000 })
$: ' 啊，不好。'
' 突如其来一阵眩晕感。\n 再站着就要贫血了。'
$执行.设置背景({ 资源路径: '/ImageAsset/bg020a.webp', 缩放: 1.021, 持续时间: 1000 })
$执行.动效动画({ 作用目标: 0, 预设名称: '摇晃', X轴幅度: 30, 持续时间: 2000 })
' 还是赶快回家避暑吧。'
$执行.设置背景({ 资源路径: '/ImageAsset/bg000a.webp', 缩放: 1.021, 持续时间: 1000 })
$action
$执行.关闭音频({ 作用目标: 'se', 持续时间: 1000 })
$等待.转场动画('BlindH8')
$执行.关闭图像({ 作用目标: 1, 持续时间: 0 })
$执行.设置背景({ 资源路径: '/ImageAsset/bg_black.webp', 缩放: 2, 持续时间: 0 })
$执行.显示界面(false)
$等待.系统计时(200.0)
$执行.显示界面(true)
$执行.设置背景({ 资源路径: '/ImageAsset/bg010a.webp', 缩放: 1.021, 持续时间: 1000 })
$执行.显示界面(false)
$等待.系统计时(500.0)
$执行.显示界面(true)
$执行.对话({ 名称: '晓', 文本: '……呼。' })
$执行.动效动画({ 作用目标: 0, 预设名称: '摇晃', Y轴幅度: 10, 持续时间: 1500.0 })
$: ' 虽说屋里没有空调，\n 但好歹能遮阳，还能吹吹风扇，也算不错了。'
' 我从口袋里掏出了被汗液略微沾湿的手机。'
晓: '唉呀。'
$: ' 委托方发来了一大串消息。'
' 我瞥了一眼，第一条就写着：\n  "非常抱歉"'
' 虽说剩余内容不用看也知道写了什么，但姑且确认一下。'
女性的声音: '导演吩咐，分镜制作要暂停。' + '/AudioClip/ona0001.flac'
'制作流程有变，请确认。' + '/AudioClip/ona0002.flac'
'请暂时等待下一步的指示。' + '/AudioClip/ona0003.flac'
晓: '我谢谢你。'
$: ' 我把手机扔到了一边。'
' 去冰箱里拿了点喝的东西，便扑倒在了床上。'
$执行.设置背景({ 资源路径: '/ImageAsset/bg_black.webp', 缩放: 2, 持续时间: 500.0 })
$执行.关闭音频({ 作用目标: 'bgm', 持续时间: 2000 })
$执行.设置音效({ 资源路径: '/AudioClip/se015.flac' })
' 真是麻烦，又被喊停了。'
' 说到底动画师只是导演的奴隶。\n 只要他没那个意思，我就什么也干不了。'
' 或许我打一开始就不该选择这个职业。'
' 当初选这个职业……还可以说怀揣着梦想的。'
$执行.设置背景({ 资源路径: '/ImageAsset/bg_white.webp', 缩放: 2, 持续时间: 1000 })
' 但这股热情现在已经丝毫不剩了。'
晓: '……'
$执行.设置背景({ 资源路径: '/ImageAsset/bg010a.webp', 缩放: 1.021, 持续时间: 1000 })
'……唉。'
$执行.动效动画({ 作用目标: 0, 预设名称: '摇晃', Y轴幅度: 10, 持续时间: 1500.0 })
$: ' 热得连我的精神都垮了。'
' 只是身体疲惫就够受的了。\n 想事情最好还是乐观一点。'
' 闲下来了。'
$执行.设置背景({ 资源路径: '/ImageAsset/bg_black.webp', 缩放: 2, 持续时间: 1000 })
' 换句话说，假期来了。'
' 趁现在，我想干什么都可以。\n 找点事做吧。'
晓: '……'
' 可没有能做的事啊。'
$执行.设置背景({ 资源路径: '/ImageAsset/bg010a.webp', 缩放: 1.021, 持续时间: 1000 })
$: ' 我现在可以说什么都不想干。'
' 最近的生活就是拖着疲惫的身子，每天完成工作，\n 然后饮酒，睡觉。日复一日。'
' 仅仅是把我该干的干完，\n 其他的什么都没想过。'
' 用没有任何想要做的事情为由。\n 借以逃避。'
晓: '……'
$action
$执行.设置背景({ 资源路径: '/ImageAsset/bg_white.webp', 缩放: 2, 持续时间: 500.0 })
$执行.显示界面(false)
$等待.系统计时(500.0)
$执行.显示界面(true)
$执行.对话({ 名称: '音理', 文本: '去旅行嘛！', 语音: '/AudioClip/ner0001.flac' })
晓: '……'
$执行.设置背景({ 资源路径: '/ImageAsset/bg010a.webp', 缩放: 1.021, 持续时间: 1000 })
$: ' 唉。'
' 我抬起沉重的身体，坐在了电脑前。'
$执行.设置背景({ 资源路径: '/ImageAsset/large_bg010a.webp', X坐标: -940.0, Y坐标: -360.0, 持续时间: 1000 })
$执行.动效动画({ 作用目标: 0, 预设名称: '摇晃', Y轴幅度: 15, 持续时间: 2000 })
' 旅行社……选哪一家比较好呢。\n 从来没有过这种经验，一点都不了解。'
' 就选它好了。\n 天河……银河……嗯。'
' 必需的身份证明，好像驾照就够了吧……？'
$执行.设置背景({ 资源路径: '/ImageAsset/bg000a.webp', 缩放: 1.021, 持续时间: 1000 })
' 怎么办手续呢，'
' 我看看……'
$执行.设置背景({ 资源路径: '/ImageAsset/bg000b.webp', 缩放: 1.021, 持续时间: 1000 })
' 就这样，我踏出了此次旅程的第一步。'
$执行.设置背景({ 资源路径: '/ImageAsset/bg000d.webp', 缩放: 1.021, 持续时间: 1000 })
' 这是个平平无奇的起点。\n 我不过是在网上偶然找了这家旅行社。'
' 随后……'
' 一场特殊的旅行开始了。'
$执行.解锁成就(0)
$执行.关闭音频({ 作用目标: 'bgm', 持续时间: 2000 })
$action
$执行.解锁鉴赏('music1')
$等待.播放视频({ 资源路径: '/OP.mp4' })
```

## 代码基础

本章节介绍一些基础语法。

### 分号

分号`;`用于表示一条语句的结束。

在大部分情况下都可以省略分号，如果遇到报错，可以尝试在两个语句之间添加分号。

比如，连续写两个使用反引号 `` `...` `` 的文本时，就必须用分号分隔。

```js
`...` ; `...`
```

### 文本

文本需要用单引号 `'...'` 双引号 `"..."` 或反引号 `` `...` `` 包裹。

如果需要在文本中插入变量或表达式，使用反引号，并用 `${}` 表示变量。

```js
"你好" ; '世界' ; `你好，${名字}`
```

#### 转义字符

如果需要在文本中插入特殊字符（如换行或引号），可以使用反斜杠 `\` 转义：

常见的转义字符：`\n` 表示换行，`\"` 表示双引号，`\\` 表示反斜杠。

```js
"第一行\n第二行" ; "他说：\"你好\""
```

### 数字

可以直接书写整数或小数：

```js
42 ; 3.14
```

### 条件

表示“是”或“否”的两个值：

```js
true ; false
```

### 列表

列表用方括号 `[]` 表示，元素之间用逗号分隔：

```js
[1, 2, 3] ; ["A", "B"]
```

### 字典

字典用大括号 `{}` 表示，`键: 值` 组合之间用逗号分隔：

```js
{ 资源路径: "/咸鱼池塘.jpg", 持续时间: 500 }
```

### 常量

使用 `const` 声明一个常量：

```js
const 常量 = 423
```

### 分支

分支需要配合条件判断使用，条件成立时为 true，不成立时为 false：

可以使用 `<` `>` `<=` `>=` 比较数字，等于`===`和不等于`!==`比较数字和文本。

可以使用 `&&` 和 `||` 连接多个条件，`&&` 相当于 且，`||` 相当于 或。

```js
(a > b && a < c) || a < d // 当 a大于b且a小于c 或 a小于d 时 条件成立
```

使用 `if` `else if` `else` 分支代码，`else if` 和 `else` 是可选的：

```js
if (条件1) {
  // 条件1 为 true 时执行
} else if (条件2) {
  // 条件1 为 false 且 条件2 为 true 时执行
} else {
  // 以上条件都不成立时执行
}
```

### 注释

除文本外，`//`之后的内容作为注释。

```js
"//不是注释" // 注释
```

### HTML

在 HTML 中，`<b>` 表示加粗、`<em>` 表示斜体强调、`<u>` 表示下划线、`<del>` 表示删除线。

注音可以使用 `<ruby>` 标签来实现，例如：`<ruby>注音<rt>zhù yīn</rt></ruby>`。

通过 `<span>` 标签包裹文本，并在 `style=""` 属性中自定义样式，可以实现更多丰富的文本效果。

```tsx
<span style="color: red">
    这是一条<b>重要</b>的消息，需要你<i>特别</i>留意。
    下面的内容<u>请务必关注</u>，不要理会<s>已经废弃</s>的提示。
</span>
```
